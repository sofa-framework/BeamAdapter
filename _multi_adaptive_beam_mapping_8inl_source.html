<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BeamAdapter: src/BeamAdapter/component/mapping/MultiAdaptiveBeamMapping.inl Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">BeamAdapter
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function() { init_codefold(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('_multi_adaptive_beam_mapping_8inl_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">MultiAdaptiveBeamMapping.inl</div></div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="comment">/******************************************************************************</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="comment">*                              BeamAdapter plugin                             *</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="comment">*                  (c) 2006 Inria, University of Lille, CNRS                  *</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="comment">*                                                                             *</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="comment">* This program is free software; you can redistribute it and/or modify it     *</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="comment">* under the terms of the GNU Lesser General Public License as published by    *</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="comment">* the Free Software Foundation; either version 2.1 of the License, or (at     *</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="comment">* your option) any later version.                                             *</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="comment">*                                                                             *</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="comment">* This program is distributed in the hope that it will be useful, but WITHOUT *</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="comment">* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or       *</span></div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="comment">* FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License *</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="comment">* for more details.                                                           *</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="comment">*                                                                             *</span></div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="comment">* You should have received a copy of the GNU Lesser General Public License    *</span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="comment">* along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.        *</span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="comment">*******************************************************************************</span></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="comment">* Authors: see Authors.md                                                     *</span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span><span class="comment">*                                                                             *</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="comment">* Contact information: contact@sofa-framework.org                             *</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span><span class="comment">******************************************************************************/</span></div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span><span class="comment">//</span></div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span><span class="comment">// C++ Implementation : UnifiedMultiMultiAdaptiveBeamMapping</span></div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span><span class="comment">//</span></div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span><span class="comment">// Description:</span></div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span><span class="comment">//</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span><span class="comment">//</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span><span class="comment">// Author: Christian Duriez, INRIA</span></div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span><span class="comment">//</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span><span class="comment">// Copyright: See COPYING file that comes with this distribution</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span><span class="comment">//</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span><span class="comment">//</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span><span class="preprocessor">#pragma once</span></div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span> </div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span><span class="preprocessor">#include &lt;BeamAdapter/component/mapping/MultiAdaptiveBeamMapping.h&gt;</span></div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span> </div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span><span class="preprocessor">#include &lt;sofa/simulation/AnimateBeginEvent.h&gt;</span></div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span><span class="preprocessor">#include &lt;sofa/core/MechanicalParams.h&gt;</span></div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span><span class="preprocessor">#include &lt;sofa/helper/ScopedAdvancedTimer.h&gt;</span></div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span> </div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span> </div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacesofa_1_1component_1_1mapping.html">sofa::component::mapping</a></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>{</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span> </div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span><span class="keyword">using </span>sofa::helper::ScopedAdvancedTimer;</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span> </div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span> </div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::MultiAdaptiveBeamMapping(core::State&lt; In &gt;* from, core::State&lt; Out &gt;* to, TInterventionalRadiologyController* _ircontroller)</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>: Inherit(from, to)</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>, useCurvAbs(initData(&amp;useCurvAbs,true,<span class="stringliteral">&quot;useCurvAbs&quot;</span>,<span class="stringliteral">&quot;true if the curvilinear abscissa of the points remains the same during the simulation if not the curvilinear abscissa moves with adaptivity and the num of segment per beam is always the same&quot;</span>))</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>, m_controlerPath(initData(&amp;m_controlerPath,<span class="stringliteral">&quot;ircontroller&quot;</span>, <span class="stringliteral">&quot;Path to the ircontroller component on scene&quot;</span>))</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>, d_parallelMapping(initData(&amp;d_parallelMapping, false, <span class="stringliteral">&quot;parallelMapping&quot;</span>, <span class="stringliteral">&quot;flag to enable parallel internal computation in all the submappings&quot;</span>))</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>, m_ircontroller(_ircontroller)</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>, isBarycentricMapping(false)</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>{</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>    this-&gt;addAlias(&amp;m_controlerPath, <span class="stringliteral">&quot;controller&quot;</span>);</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>}</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span> </div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span> </div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::MultiAdaptiveBeamMapping()</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>: Inherit()</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>, useCurvAbs(initData(&amp;useCurvAbs,true,<span class="stringliteral">&quot;useCurvAbs&quot;</span>,<span class="stringliteral">&quot;true if the curvilinear abscissa of the points remains the same during the simulation if not the curvilinear abscissa moves with adaptivity and the num of segment per beam is always the same&quot;</span>))</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>, m_controlerPath(initData(&amp;m_controlerPath,<span class="stringliteral">&quot;ircontroller&quot;</span>, <span class="stringliteral">&quot;Path to the ircontroller component on scene&quot;</span>))</div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>, d_parallelMapping(initData(&amp;d_parallelMapping, false, <span class="stringliteral">&quot;parallelMapping&quot;</span>, <span class="stringliteral">&quot;flag to enable parallel internal computation in all the submappings&quot;</span>))</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>, m_ircontroller(nullptr)</div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>, isBarycentricMapping(false)</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>{</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>    this-&gt;addAlias(&amp;m_controlerPath, <span class="stringliteral">&quot;controller&quot;</span>);</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>}</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span> </div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span> </div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span><span class="keywordtype">void</span> MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::apply(<span class="keyword">const</span> core::MechanicalParams* mparams <span class="comment">/* PARAMS FIRST */</span>, Data&lt;VecCoord&gt;&amp; dOut, <span class="keyword">const</span> Data&lt;InVecCoord&gt;&amp; dIn)</div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>{</div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>    SCOPED_TIMER(<span class="stringliteral">&quot;MultiAdaptiveBeamMapping_apply&quot;</span>);</div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span> </div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>    <span class="keyword">auto</span> out = sofa::helper::getWriteOnlyAccessor(dOut);</div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>    <span class="keywordflow">if</span>(!isBarycentricMapping)</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>        out.resize(_xPointList.size());</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(out.size() != this-&gt;getMechTo()[0]-&gt;getSize())</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>        out.resize(this-&gt;getMechTo()[0]-&gt;getSize());</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span> </div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> subMap=0; subMap&lt;m_subMappingList.size(); subMap++)</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>    {</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>        <span class="keywordflow">if</span> (this-&gt;f_printLog.getValue()){</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>            msg_info()&lt;&lt;<span class="stringliteral">&quot;apply &quot;</span>;</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>            m_subMappingList[subMap]-&gt;printIstrumentInfo();<span class="comment">//ctn_DEV</span></div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>        }</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>        m_subMappingList[subMap]-&gt;apply(mparams <span class="comment">/* PARAMS FIRST */</span>, dOut, dIn);</div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>    }</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span> </div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>}</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span> </div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span><span class="keywordtype">void</span> MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::applyJ(<span class="keyword">const</span> core::MechanicalParams* mparams <span class="comment">/* PARAMS FIRST */</span>, Data&lt;VecDeriv&gt;&amp; dOut, <span class="keyword">const</span> Data&lt;InVecDeriv&gt;&amp; dIn)</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>{</div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>    SCOPED_TIMER(<span class="stringliteral">&quot;MultiAdaptiveBeamMapping_applyJ&quot;</span>);</div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span> </div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> subMap=0; subMap&lt;m_subMappingList.size(); subMap++)</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>    {</div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>        <span class="keywordflow">if</span> (this-&gt;f_printLog.getValue()){</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>            m_subMappingList[subMap]-&gt;printIstrumentInfo();<span class="comment">//ctn_DEV</span></div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>        }</div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>        m_subMappingList[subMap]-&gt;applyJ(mparams <span class="comment">/* PARAMS FIRST */</span>, dOut, dIn);</div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>    }</div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>}</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span> </div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span><span class="keywordtype">void</span> MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::applyJT(<span class="keyword">const</span> core::MechanicalParams* mparams <span class="comment">/* PARAMS FIRST */</span>, Data&lt;InVecDeriv&gt;&amp; dOut, <span class="keyword">const</span> Data&lt;VecDeriv&gt;&amp; dIn)</div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>{</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>    SCOPED_TIMER(<span class="stringliteral">&quot;MultiAdaptiveBeamMapping_applyJT&quot;</span>);</div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span> </div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> subMap=0; subMap&lt;m_subMappingList.size(); subMap++)</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>    {</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>        <span class="keywordflow">if</span> (this-&gt;f_printLog.getValue()){</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span> </div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>            m_subMappingList[subMap]-&gt;printIstrumentInfo();<span class="comment">//ctn_DEV</span></div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>        }</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>        m_subMappingList[subMap]-&gt;applyJT(mparams <span class="comment">/* PARAMS FIRST */</span>, dOut, dIn);</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>    }</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>}</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span> </div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span> </div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span><span class="comment">// MultiAdaptiveBeamMapping::applyJT(InMatrixDeriv&amp; out, const OutMatrixDeriv&amp; in) //</span></div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span><span class="comment">// this function propagate the constraint through the Adaptive Beam mapping :</span></div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span><span class="comment">// if one constraint along (vector n) with a value (v) is applied on the childModel (like collision model)</span></div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span><span class="comment">// then this constraint is transformed by (Jt.n) with value (v) for the rigid model</span></div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span><span class="comment">// note : the value v is not propagated through the mapping</span></div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span><span class="keywordtype">void</span> MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::applyJT(<span class="keyword">const</span> core::ConstraintParams* cparams <span class="comment">/* PARAMS FIRST */</span>, Data&lt;InMatrixDeriv&gt;&amp; dOut, <span class="keyword">const</span> Data&lt;OutMatrixDeriv&gt;&amp; dIn)</div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>{</div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>    SCOPED_TIMER(<span class="stringliteral">&quot;MultiAdaptiveBeamMapping_applyJT&quot;</span>);</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span> </div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> subMap=0; subMap&lt;m_subMappingList.size(); subMap++)</div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>    {</div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>        <span class="keywordflow">if</span> (this-&gt;f_printLog.getValue()){</div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>            m_subMappingList[subMap]-&gt;printIstrumentInfo();</div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>        }</div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>        m_subMappingList[subMap]-&gt;applyJT(cparams <span class="comment">/* PARAMS FIRST */</span>, dOut, dIn);</div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>    }</div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>}</div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span> </div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span> </div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span> </div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span> </div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span><span class="keywordtype">void</span> MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::handleEvent(sofa::core::objectmodel::Event * event)</div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>{</div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span>    <span class="keywordflow">if</span> (sofa::simulation::AnimateBeginEvent::checkEventType(event))</div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>    {</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>        assignSubMappingFromControllerInfo();</div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>    }</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>}</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span> </div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="foldopen" id="foldopen00158" data-start="{" data-end="}">
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno"><a class="line" href="classsofa_1_1component_1_1mapping_1_1_multi_adaptive_beam_mapping.html#aa7958f6357d85d2b66e96d9e3a414c36">  158</a></span><span class="keywordtype">void</span> <a class="code hl_class" href="classsofa_1_1component_1_1mapping_1_1_multi_adaptive_beam_mapping.html">MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::assignSubMappingFromControllerInfo</a>()</div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span>{</div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>    sofa::type::vector&lt;int&gt; removeEdgeAtPoint;</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span> </div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>    <span class="comment">// 1. get the new controls</span></div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>    m_ircontroller-&gt;interventionalRadiologyCollisionControls(_xPointList, _idm_instrumentList, removeEdgeAtPoint);</div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>    </div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>    <span class="keywordflow">if</span>(!isBarycentricMapping)</div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>    {</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>        </div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>        <span class="comment">//Case if this is not a barycentric mapping</span></div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>        <span class="comment">// 2. assign each value of xPointList to the corresponding &quot;sub Mapping&quot;</span></div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>        <span class="comment">// i.e = each point from xPointList of the collision model is controlled by a given instrument wich id is provided in _id_m_instrumentList</span></div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;m_subMappingList.size(); i++)</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>        {</div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>            <span class="keyword">auto</span> pointList = sofa::helper::getWriteOnlyAccessor(m_subMappingList[i]-&gt;d_points);</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>            pointList.clear();</div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>            m_subMappingList[i]-&gt;clearIdPointSubMap();</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>        }</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span> </div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt; _xPointList.size(); i++)</div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>        {</div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  <span class="keywordtype">id</span> = _idm_instrumentList[i];</div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span> </div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>            <span class="keyword">auto</span> pointList = sofa::helper::getWriteOnlyAccessor(m_subMappingList[<span class="keywordtype">id</span>]-&gt;d_points);</div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>            pointList.wref().emplace_back(  _xPointList[i], 0, 0 );</div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span> </div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>            m_subMappingList[id]-&gt;addIdPointSubMap(i);</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span>        }</div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span> </div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>        <span class="comment">// handle the possible topological change</span></div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span>        sofa::type::vector&lt;sofa::core::topology::BaseMeshTopology::EdgeID&gt; edgeToRemove;</div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span> </div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;removeEdgeAtPoint.size(); i++)</div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>        {</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>            sofa::type::vector&lt;sofa::core::topology::BaseMeshTopology::PointID&gt; baseEdge(0);</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>            baseEdge = _topology-&gt;getEdgesAroundVertex((sofa::core::topology::BaseMeshTopology::PointID) removeEdgeAtPoint[i]);</div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span> </div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>            <span class="keywordflow">if</span> (baseEdge.size() == 2)</div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>            {</div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span>                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;baseEdge.size(); i++)</div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span>                {</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span>                    <span class="keyword">const</span> sofa::core::topology::BaseMeshTopology::Edge e = _topology-&gt;getEdge(baseEdge[i]);</div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>                    <span class="keywordflow">if</span>( ((<span class="keywordtype">int</span>) e[1]== removeEdgeAtPoint[i] &amp;&amp; e[1] &gt; e[0]) || ((<span class="keywordtype">int</span>) e[0]==removeEdgeAtPoint[i] &amp;&amp; e[0] &gt; e[1]) )</div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span>                    {</div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>                        edgeToRemove.push_back(baseEdge[i]);</div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>                    }</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>                }</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>            }</div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (baseEdge.size() == 1)</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span>            {</div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span>                msg_info()&lt;&lt;<span class="stringliteral">&quot; ok, the edge is already suppressed&quot;</span>;</div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span>            }</div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>            {</div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>                msg_error() &lt;&lt; <span class="stringliteral">&quot;Trying to remove baseEdge which is alreay empty. This case is not supposed to happened.&quot;</span>;</div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span>            }</div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span> </div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>            <span class="keywordflow">if</span> (edgeToRemove.size()&gt;0)</div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span>            {</div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span>                _edgeMod-&gt;removeEdges(edgeToRemove,<span class="keyword">false</span>);</div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span> </div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>            }</div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span>        }</div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>    }</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span> </div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span>    <span class="keyword">const</span> core::MechanicalParams* _mparams = core::MechanicalParams::defaultInstance();</div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span> </div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span>    this-&gt;apply(_mparams <span class="comment">/* PARAMS FIRST */</span>, *this-&gt;getToModel()-&gt;write(sofa::core::vec_id::write_access::position),*this-&gt;getFromModel()-&gt;read(sofa::core::vec_id::read_access::position));</div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span> </div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>    <span class="keyword">const</span> Data&lt;InVecCoord&gt;&amp; xfree_in = *this-&gt;getFromModel()-&gt;read(sofa::core::vec_id::read_access::freePosition);</div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span> </div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span>    <span class="keyword">const</span> Data&lt;VecCoord&gt;&amp;     x_out = *this-&gt;getToModel()-&gt;read(sofa::core::vec_id::read_access::position);</div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span>    <span class="keyword">const</span> Data&lt;VecCoord&gt;&amp; xfree_out = *this-&gt;getToModel()-&gt;read(sofa::core::vec_id::read_access::freePosition);</div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span> </div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span>    core::behavior::MechanicalState&lt;TOut&gt;* ms_out =     <span class="keyword">dynamic_cast&lt;</span>core::behavior::MechanicalState&lt;TOut&gt; *<span class="keyword">&gt;</span> (this-&gt;getToModel());</div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span> </div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>    <span class="keywordflow">if</span> (x_out.getValue().size() != xfree_out.getValue().size())</div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>    {</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span>        ms_out-&gt;vInit(_mparams,sofa::core::vec_id::write_access::freePosition,sofa::core::vec_id::read_access::position);</div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>        ms_out-&gt;vInit(_mparams,sofa::core::vec_id::write_access::freeVelocity,sofa::core::vec_id::read_access::velocity);</div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>    }</div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span> </div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span>    <span class="keywordflow">if</span> (xfree_in.getValue().size() &gt; 0)</div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>    {</div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>        this-&gt;apply(_mparams <span class="comment">/* PARAMS FIRST */</span>, *this-&gt;getToModel()-&gt;write(sofa::core::vec_id::write_access::freePosition),    *this-&gt;getFromModel()-&gt;read(sofa::core::vec_id::read_access::freePosition));</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>    }</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>}</div>
</div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span> </div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span> </div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span> </div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span><span class="keywordtype">void</span> <a class="code hl_class" href="classsofa_1_1component_1_1mapping_1_1_multi_adaptive_beam_mapping.html">MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::init</a>()</div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>{</div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span>    <span class="keywordflow">if</span> (m_ircontroller==<span class="keyword">nullptr</span>) </div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span>    {</div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span>        core::objectmodel::BaseContext * c = this-&gt;getContext();</div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span> </div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>        <span class="keyword">const</span> type::vector&lt;std::string&gt;&amp; interpolName = m_controlerPath.getValue();</div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span>        <span class="keywordflow">if</span> (interpolName.empty()) {</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span>            m_ircontroller = c-&gt;get&lt;TInterventionalRadiologyController&gt;(core::objectmodel::BaseContext::Local);</div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span>            m_ircontroller = c-&gt;get&lt;TInterventionalRadiologyController&gt;(m_controlerPath.getValue()[0]);</div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span>        }</div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span> </div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span>        <span class="keywordflow">if</span> (m_ircontroller == <span class="keyword">nullptr</span>) {</div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span>            msg_error() &lt;&lt; <span class="stringliteral">&quot; no Beam Interpolation found !!! the component can not work&quot;</span>;</div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span>            sofa::core::objectmodel::BaseObject::d_componentState.setValue(sofa::core::objectmodel::ComponentState::Invalid);</div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span>            <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span>        }</div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span>        <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span>            msg_info() &lt;&lt; <span class="stringliteral">&quot; interpolation named&quot;</span> &lt;&lt; m_ircontroller-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; found (for &quot;</span> &lt;&lt; this-&gt;getName() &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span>        }</div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>    }</div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span> </div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span>    m_ircontroller-&gt;getInstrumentList(m_instrumentList);</div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span> </div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>    <span class="comment">// create a mapping for each instrument</span></div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>    m_subMappingList.clear();</div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span>    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;m_instrumentList.size(); i++)</div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span>    {</div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>        <span class="keyword">typename</span> AdaptiveBeamMapping&lt; TIn, TOut&gt;::SPtr newMapping = sofa::core::objectmodel::New&lt;AdaptiveBeamMapping&lt; TIn, TOut&gt;&gt;(this-&gt;fromModel, this-&gt;toModel,m_instrumentList[i],<span class="keyword">true</span>);</div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span>        newMapping-&gt;d_parallelMapping.setParent(&amp;d_parallelMapping);</div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span>        newMapping-&gt;d_parallelMapping.update();</div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span>        m_subMappingList.push_back(newMapping);</div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span>    }</div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span> </div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span> </div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span>    this-&gt;f_listening.setValue(<span class="keyword">true</span>);</div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span> </div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span>    this-&gt;getContext()-&gt;get(_topology);</div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span> </div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>    <span class="keywordflow">if</span> (_topology != <span class="keyword">nullptr</span> &amp;&amp; this-&gt;f_printLog.getValue()) {</div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span>        msg_info() &lt;&lt; <span class="stringliteral">&quot; FIND topology named &quot;</span> &lt;&lt; _topology-&gt;getName();</div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span>    }</div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span> </div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span>    this-&gt;getContext()-&gt;get(_edgeMod);</div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span> </div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span>    <span class="keywordflow">if</span> (_edgeMod == <span class="keyword">nullptr</span>)</div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span>        msg_error() &lt;&lt; <span class="stringliteral">&quot;EdgeSetController has no binding EdgeSetTopologyModifier.&quot;</span>;</div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span> </div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span>    <span class="comment">// fill topology :</span></div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span>    _topology-&gt;clear();</div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span>    _topology-&gt;cleanup();</div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span> </div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> numSeg, numLinesInstrument;</div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span>    numSeg=0;</div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span>    InReal DX=0;</div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span>    <span class="comment">// we chose the collision parameters of the most discrestized instrument</span></div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;m_instrumentList.size(); i++)</div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span>    {</div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span>        InReal dx=0;</div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span>        m_instrumentList[i]-&gt;getNumberOfCollisionSegment(dx, numLinesInstrument);</div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>        <span class="keywordflow">if</span>( numSeg &lt; numLinesInstrument ){</div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>            numSeg = numLinesInstrument;</div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span>            DX=dx;</div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>        }</div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span>    }</div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span> </div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span>    msg_info() &lt;&lt; <span class="stringliteral">&quot;numSeg found in MultiAdaptiveBeamMapping=&quot;</span>&lt;&lt; numSeg;</div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span> </div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span> </div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span>    <span class="comment">// add points</span></div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span>    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;(int)numSeg+1; i++)</div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span>    {</div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span>        Real px = i*DX;</div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>        _topology-&gt;addPoint( px, 0, 0);</div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>    }</div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>    <span class="comment">// add segments</span></div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;(int)numSeg; i++)</div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span>    {</div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span>        _topology-&gt;addEdge(i,i+1);</div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span>    }</div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span> </div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span>    <span class="comment">// create edge around vertex array</span></div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span>    _topology-&gt;init();</div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span> </div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span>    <span class="comment">// resize Mstate</span></div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span>    this-&gt;toModel-&gt;resize(numSeg+1);</div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span> </div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>    <span class="comment">// resize the internal list of the collision points ( for each point : [x_curv on the global wire , id of the corresponding instrument]</span></div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>    _xPointList.resize(numSeg+1);</div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>    _idm_instrumentList.resize(numSeg+1);</div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span>}</div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span> </div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span> </div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span><span class="keywordtype">void</span> MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::bwdInit()</div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>{</div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span> </div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span>    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;m_instrumentList.size(); i++)</div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span>    {</div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span>        m_subMappingList[i]-&gt;setUseCurvAbs(this-&gt;useCurvAbs.getValue());</div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>        m_subMappingList[i]-&gt;setName(<span class="stringliteral">&quot; SubMapping - &quot;</span> + m_instrumentList[i]-&gt;getName() );</div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>        m_subMappingList[i]-&gt;bwdInit();</div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span>    }</div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span>    assignSubMappingFromControllerInfo();</div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span> </div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>}</div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span> </div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span> </div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span><span class="keywordtype">void</span> MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::setBarycentricMapping()</div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span>{</div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span>    isBarycentricMapping=<span class="keyword">true</span>;</div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span>    <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;i&lt;m_subMappingList.size();i++)</div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span>    {</div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>        m_subMappingList[i]-&gt;setBarycentricMapping();</div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>    }</div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>}</div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span> </div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span><span class="keywordtype">int</span> MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::addBaryPoint(<span class="keyword">const</span> <span class="keywordtype">int</span>&amp; edgeId,<span class="keyword">const</span> Vec3&amp; _baryCoord,<span class="keywordtype">bool</span> isStraight)</div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span>{</div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>    <span class="keywordtype">int</span> returnId=this-&gt;getMechTo()[0]-&gt;getSize();</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span>    this-&gt;getMechTo()[0]-&gt;resize(returnId+1);</div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span> </div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>    assert(m_ircontroller !=<span class="keyword">nullptr</span> &amp;&amp; isBarycentricMapping);</div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>    <span class="keyword">const</span> type::vector&lt;type::vector&lt;int&gt; &gt;&amp; id_instrument_curvAbs_table = m_ircontroller-&gt;get_id_instrument_curvAbs_table();</div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>    <span class="keywordtype">int</span> nbControlledEdge  = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(id_instrument_curvAbs_table.size()) - 1;</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span>    <span class="keywordtype">int</span> totalNbEdges = m_ircontroller-&gt;getTotalNbEdges();</div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span>    <span class="keywordtype">int</span> nbUnControlledEdges = totalNbEdges - nbControlledEdge;</div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span>    assert(nbUnControlledEdges&gt;=0);</div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span> </div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>    <span class="keywordflow">if</span> (edgeId &lt; (totalNbEdges-nbControlledEdge) )</div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>    {</div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>        <span class="comment">//if the edge in question is not under control, dont need to compute for collision</span></div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span>    }</div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span>    <span class="keywordflow">else</span></div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>    {</div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span>        <span class="keywordtype">int</span> controledEdgeId = edgeId-nbUnControlledEdges;</div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span>        <span class="keyword">const</span> sofa::type::vector&lt;int&gt;&amp;  id_instrument_table_on_node = id_instrument_curvAbs_table[controledEdgeId+1];</div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span>        sofa::type::vector&lt; sofa::component::fem::WireBeamInterpolation&lt;In&gt;  *&gt; m_instrumentsList;</div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span>        m_ircontroller-&gt;getInstrumentList(m_instrumentsList);</div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span>        Real radius = m_instrumentsList[id_instrument_table_on_node[0]]-&gt;getBeamSection(controledEdgeId)._r;</div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span>        <span class="keywordtype">int</span> idInstrument  = id_instrument_table_on_node[0];</div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span>        <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=1;i&lt;id_instrument_table_on_node.size();i++)</div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span>        {</div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span>            <span class="keywordflow">if</span>(radius &lt; m_instrumentsList[id_instrument_table_on_node[i]]-&gt;getBeamSection(controledEdgeId)._r)</div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span>            {</div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span>                radius = m_instrumentsList[id_instrument_table_on_node[i]]-&gt;getBeamSection(controledEdgeId)._r;</div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span>                idInstrument = id_instrument_table_on_node[i];</div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span>            }</div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span>        }</div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span>        m_subMappingList[idInstrument]-&gt;addBaryPoint(controledEdgeId,_baryCoord,isStraight);</div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span>        m_subMappingList[idInstrument]-&gt;addIdPointSubMap(returnId);</div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span>    }</div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span>    <span class="keywordflow">return</span> returnId;</div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span>}</div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span> </div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span><span class="keyword">template</span> &lt;<span class="keyword">class</span> TIn, <span class="keyword">class</span> TOut&gt;</div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span><span class="keywordtype">void</span> MultiAdaptiveBeamMapping&lt; TIn, TOut&gt;::clear(<span class="keywordtype">int</span> size)</div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span>{</div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span>    <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;i&lt;m_subMappingList.size();i++)</div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span>        m_subMappingList[i]-&gt;clear(size);</div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span>    this-&gt;getMechTo()[0]-&gt;resize(0);</div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span>}</div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span> </div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span> </div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span>} <span class="comment">// namespace sofa::component::mapping</span></div>
<div class="ttc" id="aclasssofa_1_1component_1_1mapping_1_1_multi_adaptive_beam_mapping_html"><div class="ttname"><a href="classsofa_1_1component_1_1mapping_1_1_multi_adaptive_beam_mapping.html">sofa::component::mapping::MultiAdaptiveBeamMapping</a></div><div class="ttdoc">MultiAdaptiveBeamMapping Class.</div><div class="ttdef"><b>Definition</b> MultiAdaptiveBeamMapping.h:48</div></div>
<div class="ttc" id="anamespacesofa_1_1component_1_1mapping_html"><div class="ttname"><a href="namespacesofa_1_1component_1_1mapping.html">sofa::component::mapping</a></div><div class="ttdoc">Forward declarations, see https://en.wikipedia.org/wiki/Forward_declaration.</div><div class="ttdef"><b>Definition</b> AdaptiveBeamMapping.cpp:45</div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_1974de49d08fb87a0aadc515bc0ea43c.html">BeamAdapter</a></li><li class="navelem"><a class="el" href="dir_084a659d65bb45ff503e6dd609823a8c.html">component</a></li><li class="navelem"><a class="el" href="dir_429833ab1b4ac5c228963ef763dbd568.html">mapping</a></li><li class="navelem"><b>MultiAdaptiveBeamMapping.inl</b></li>
    <li class="footer">Generated on Wed Jan 8 2025 09:20:02 for BeamAdapter by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
